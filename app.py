import streamlit as st
import librosa
import numpy as np
import pandas as pd
import tempfile
import os

# â˜… Streamlit ã®ãƒšãƒ¼ã‚¸è¨­å®šï¼ˆå¿…ãšæœ€ä¸Šéƒ¨ï¼‰ â˜…
st.set_page_config(
    page_title="ã€ç²¾å¯†è§£æã€‘ãã‚‰ã‚‹ãƒ»ã‚·ãƒ³ã‚¯ãƒ­ç‡ãƒã‚§ãƒƒã‚«ãƒ¼",
    layout="centered"
)

# ====== ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ ======
@st.cache_data
def load_soraru_data():
    df = pd.read_csv("soraru_data.csv")
    return df

df = load_soraru_data()

# ====== éŸ³å£°ç‰¹å¾´é‡æŠ½å‡º ======
def extract_user_features_from_file(uploaded_file, duration=15):
    with tempfile.NamedTemporaryFile(delete=False, suffix=".wav") as tmp:
        tmp.write(uploaded_file.read())
        tmp_path = tmp.name

    y, sr = librosa.load(tmp_path, duration=duration)
    os.remove(tmp_path)

    mfcc = librosa.feature.mfcc(y=y, sr=sr, n_mfcc=13)
    mfcc_mean = np.mean(mfcc, axis=1)
    mfcc_std = np.std(mfcc, axis=1)
    return np.concatenate([mfcc_mean, mfcc_std])

# ====== è·é›¢ â†’ ã‚¹ã‚³ã‚¢å¤‰æ› ======
def convert_to_score(dist, min_dist, max_dist):
    if max_dist == min_dist:
        return 50.0
    score = 1 - (dist - min_dist) / (max_dist - min_dist)
    score = score * 100
    return max(5, min(score, 100))  # æœ€ä½5%

# ====== ç·åˆãã‚‰ã‚‹ç‡ + æ›²ãƒ©ãƒ³ã‚­ãƒ³ã‚° ======
def analyze_all(user_feat, df):
    song_feats = df[[f"mfcc_{i}" for i in range(26)]].values

    all_dists = []
    for i in range(len(song_feats)):
        for j in range(i + 1, len(song_feats)):
            all_dists.append(np.linalg.norm(song_feats[i] - song_feats[j]))

    min_dist = min(all_dists)
    max_dist = max(all_dists)

    soraru_center = song_feats.mean(axis=0)
    dist_total = np.linalg.norm(user_feat - soraru_center)
    soraru_rate = convert_to_score(dist_total, min_dist, max_dist)

    results = []
    for (_, row), song_feat in zip(df.iterrows(), song_feats):
        dist = np.linalg.norm(user_feat - song_feat)
        score = convert_to_score(dist, min_dist, max_dist)
        results.append({
            "song": row["song"],
            "url": row["youtube_url"],
            "score": score
        })

    df_res = pd.DataFrame(results).sort_values("score", ascending=False)
    return soraru_rate, df_res

# ====== ã‚³ãƒ¡ãƒ³ãƒˆç”Ÿæˆï¼ˆã‚ãªãŸã®å…¨æ–‡ã‚’ãã®ã¾ã¾åæ˜ ï¼‰ ======
def generate_comment(rate: float) -> str:

    if rate >= 95:
        return ("ã€ç¥åŸŸã®åŒèª¿ã€‘ã‚‚ã¯ã‚„åˆ¤åˆ¥ä¸èƒ½ã€æœ¬äººé™è‡¨ãƒ¬ãƒ™ãƒ«ã§ã™ã€‚å£°ã®ç«‹ã¡ä¸ŠãŒã‚Šã‹ã‚‰æ¶ˆãˆéš›ã®ã‚¹ãƒ¼ãƒƒã¨ã—ãŸæ¸›è¡°ã¾ã§ã€"
                "ãã‚‰ã‚‹ã•ã‚“ã®æ³¢å½¢ã‚’ãã®ã¾ã¾ãªãã£ãŸã‹ã®ã‚ˆã†ãªä¸€è‡´ã‚’è¦‹ã›ã¦ã„ã¾ã™ã€‚ç©ºæ°—ã«æº¶ã‘ã‚‹ã‚ˆã†ãªé€æ˜æ„Ÿã¨ã€"
                "è€³å…ƒã§å›ã‹ã‚Œã¦ã„ã‚‹ã‚ˆã†ãªå®Ÿåœ¨æ„Ÿã‚’åŒæ™‚ã«æŒã£ã¦ãŠã‚Šã€è´ãäººã‚’ä¸€ç¬ã§ã€ç¢§ã®ä¸–ç•Œã€ã¸å¼•ããšã‚Šè¾¼ã‚€é­”åŠ›ã‚’æŒã£ã¦ã„ã¾ã™ã€‚")

    elif rate >= 90:
        return ("ã€è»¢ç”Ÿã‚¯ãƒ©ã‚¹ã€‘é©šç•°çš„ãªã‚·ãƒ³ã‚¯ãƒ­ç‡ã§ã™ã€‚ãã‚‰ã‚‹ã•ã‚“ç‰¹æœ‰ã®ã€æ¸©ã‹ã¿ã®ã‚ã‚‹ç„¡æ©Ÿè³ªã•ã€ã‚’è¦‹äº‹ã«å†ç¾ã—ã¦ã„ã¾ã™ã€‚"
                "ç‰¹ã«é«˜éŸ³åŸŸã¸æŠœã‘ã‚‹éš›ã®ã€åˆ‡ãªã•ã‚’å­•ã‚“ã æ¯ã®æ··ãœæ–¹ã¯å¤©æ€§ã®ã‚‚ã®ã¨è¨€ãˆã‚‹ã§ã—ã‚‡ã†ã€‚ãƒã‚¤ã‚¯ã‚’é€šã—ãŸç¬é–“ã«å®Œæˆã•ã‚Œã‚‹ãã®éŸ¿ãã¯ã€"
                "ã‚‚ã¯ã‚„è»¢ç”Ÿã—ãŸãã‚‰ã‚‹ã•ã‚“æœ¬äººã¨è¨€ã£ã¦ã‚‚éè¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚è‡ªä¿¡ã‚’æŒã£ã¦ã€ãã‚‰ã‚‹ãƒœã‚¤ã‚¹ã€ã‚’åä¹—ã£ã¦ãã ã•ã„ã€‚")

    elif rate >= 85:
        return ("ã€è‡³é«˜ã®å…±é³´ã€‘ã€ãƒ“ãƒ¼ç‰ã®ä¸­ã®å®‡å®™ã€ã‚’ãã®ã¾ã¾ä½“ç¾ã—ãŸã‚ˆã†ãªã€æ¾„ã‚“ã éŸ¿ãã‚’æŒã£ã¦ã„ã¾ã™ã€‚ä¸­éŸ³åŸŸã®å®‰å®šæ„Ÿã¨ã€"
                "ãã“ã«ä¹—ã‚‹ç¹Šç´°ãªã‚¦ã‚£ã‚¹ãƒ‘ãƒ¼æˆåˆ†ã®æ¯”ç‡ãŒé»„é‡‘æ¯”ã«è¿‘ã„çŠ¶æ…‹ã§ã™ã€‚ãµã¨ã—ãŸç¬é–“ã®ãƒ‹ãƒ¥ã‚¢ãƒ³ã‚¹ãŒé©šãã»ã©æœ¬äººã«ä¼¼ã¦ã„ã‚‹ãŸã‚ã€"
                "åˆè¦‹ã®ãƒªã‚¹ãƒŠãƒ¼ã¯é–“é•ã„ãªãè€³ã‚’ç–‘ã†ã¯ãšã€‚ãƒŸãƒƒã‚¯ã‚¹ã§ãƒªãƒãƒ¼ãƒ–ã‚’æ·±ã‚ã«æ›ã‘ã‚Œã°ã€å®Œç’§ã«åŒ–ã‘ã‚‹ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ãŒã‚ã‚Šã¾ã™ã€‚")

    elif rate >= 80:
        return ("ã€æ¥µã‚ã¦é«˜ã„è¦ªå’Œæ€§ã€‘ã‹ãªã‚Šã®é«˜ã‚·ãƒ³ã‚¯ãƒ­ç‡ã§ã™ã€‚ä¸­éŸ³åŸŸã®åšã¿ã¨ã€åæ¯ãŒæ··ã–ã‚Šåˆã†ã€ã‚¨ãƒ¢ãƒ¼ã‚·ãƒ§ãƒŠãƒ«ãªè³ªæ„Ÿã€ãŒéå¸¸ã«è¿‘ãã€"
                "ãã‚‰ã‚‹ã•ã‚“ã®æ¥½æ›²ã€ç‰¹ã«ãƒãƒ©ãƒ¼ãƒ‰ã§ã®è¡¨ç¾åŠ›ãŒçˆ†ç™ºçš„ã«é«˜ã¾ã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚å£°ã®æŠœã‘æ„ŸãŒéå¸¸ã«ã‚¹ãƒ ãƒ¼ã‚ºã§ã€"
                "è´ãæ‰‹ã«ã‚¹ãƒˆãƒ¬ã‚¹ã‚’ä¸ãˆãªã„ç™’ã‚„ã—ã®æˆåˆ†ãŒãŸã£ã·ã‚Šè©°ã¾ã£ã¦ã„ã¾ã™ã€‚ã‚ã¨ä¸€æ­©ã§ã€ç¥åŸŸã«æ‰‹ãŒå±Šãä½ç½®ã«ã„ã¾ã™ã€‚")

    elif rate >= 75:
        return ("ã€ãƒã‚¤ãƒ¬ãƒ™ãƒ«ãªåŒèª¿ã€‘ã‹ãªã‚Šä¼¼ã¦ã„ã¾ã™ã€‚ç‰¹ã«ãƒ•ãƒ¬ãƒ¼ã‚ºçµ‚ã‚ã‚Šã®ã€æ¯ã®æŠœãæ–¹ã€ã‚„ã€è¨€è‘‰ã®é ­ã«ç½®ãã‚¨ãƒƒã‚¸ãƒœã‚¤ã‚¹ã®ä½¿ã„æ–¹ãŒã€"
                "ãã‚‰ã‚‹ã•ã‚“ã®æ­Œå”±ã‚¹ã‚¿ã‚¤ãƒ«ã¨æ·±ãå…±é³´ã—ã¦ã„ã¾ã™ã€‚æ­Œã„æ–¹ã‚„å£°ã®è¡¨æƒ…ã«ç¢ºã‹ãªã€ãã‚‰ã‚‹å‘³ã€ãŒã‚ã‚Šã€ãƒ•ã‚¡ãƒ³ãªã‚‰æ€ã‚ãšãƒ‹ãƒ¤ãƒªã¨ã—ã¦ã—ã¾ã†ã¯ãšã€‚"
                "æ„è­˜ã—ã¦ä½éŸ³ã®éŸ¿ãã‚’æ·±ã‚ã‚‹ã ã‘ã§ã€ã•ã‚‰ã«ã‚·ãƒ³ã‚¯ãƒ­ç‡ã¯è·³ã­ä¸ŠãŒã‚‹å¯èƒ½æ€§ã‚’ç§˜ã‚ã¦ã„ã¾ã™ã€‚")

    elif rate >= 70:
        return ("ã€ç¢ºã‹ãªãã‚‰ã‚‹æˆåˆ†ã€‘å£°ã®æŠœã‘æ„Ÿã‚„ã€é¼»ã«æŠœã‘ã‚‹ç”˜ã„éŸ¿ãã«ãã‚‰ã‚‹ã•ã‚“ã®ã‚¨ãƒƒã‚»ãƒ³ã‚¹ã‚’å¼·ãæ„Ÿã˜ã¾ã™ã€‚å…¨ä½“çš„ã«è½ã¡ç€ã„ãŸãƒˆãƒ¼ãƒ³ã§ã‚ã‚ŠãªãŒã‚‰ã€"
                "ã‚µãƒ“ãªã©ã§è¦‹ã›ã‚‹èŠ¯ã®å¼·ã•ãŒãã‚‰ã‚‹ã•ã‚“ã®æ­Œå”±è¨­è¨ˆã«éå¸¸ã«ä¼¼ã¦ã„ã¾ã™ã€‚ä»Šã®ã¾ã¾ã§ã‚‚ååˆ†ã€ä¼¼ã¦ã„ã‚‹ã€ã¨è¨€ã‚ã‚Œã‚‹ãƒ¬ãƒ™ãƒ«ã§ã™ãŒã€"
                "ã‚‚ã†å°‘ã—ã ã‘ã€è„±åŠ›æ„Ÿã€ã‚’æ„è­˜ã—ã¦æ­Œã†ã¨ã€ã‚ˆã‚Šæœ¬äººã«è¿‘ã„ã‚¢ãƒ³ãƒ‹ãƒ¥ã‚¤ãªé­…åŠ›ãŒå¢—ã™ã§ã—ã‚‡ã†ã€‚")

    elif rate >= 65:
        return ("ã€æ½œåœ¨çš„ã‚·ãƒ³ã‚¯ãƒ­ã€‘ã¨ã“ã‚ã©ã“ã‚ã«å¼·ã„ã€ãã‚‰ã‚‹æˆåˆ†ã€ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚å…¨ã¦ã®å¸¯åŸŸã§ã¯ã‚ã‚Šã¾ã›ã‚“ãŒã€"
                "ç‰¹å®šã®éŸ³åŸŸï¼ˆç‰¹ã«ä¸­ä½éŸ³ï¼‰ã«ãŠã„ã¦ã€ãƒãƒƒã¨ã™ã‚‹ã»ã©ä¼¼ãŸéŸ¿ãã‚’è¦‹ã›ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚è‡ªåˆ†ã®å€‹æ€§ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¤ã¤ã€"
                "ãã‚‰ã‚‹ã•ã‚“ã®ã‚¨ãƒƒã‚»ãƒ³ã‚¹ã‚’çµ¶å¦™ãªã‚¹ãƒ‘ã‚¤ã‚¹ã¨ã—ã¦æŒã£ã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚å¯„ã›ã‚‹æŠ€è¡“ã‚’ç£¨ã‘ã°ã€ã¾ã ã¾ã ä¸Šã‚’ç‹™ãˆã‚‹ä¼¸ã³ä»£ã‚’æ„Ÿã˜ã¾ã™ã€‚")

    elif rate >= 60:
        return ("ã€ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰ãƒ»ãƒœã‚¤ã‚¹ã€‘ã‚ãªãŸè‡ªèº«ã®å€‹æ€§ã‚’ä¸»è»¸ã«ã—ã¤ã¤ã€ãã‚‰ã‚‹ã•ã‚“ã®ã‚ˆã†ãªã€é™å¯‚ã‚’çºã£ãŸéŸ¿ãã€ã‚’ä¸€éƒ¨ã«æŒã£ã¦ã„ã¾ã™ã€‚"
                "å…¨ã¦ã®æ›²ã¨ã„ã†ã‚ˆã‚Šã¯ã€ç‰¹å®šã®æ¥½æ›²ï¼ˆä¾‹ãˆã°ã€éŠ€ã®ç¥ˆèª“ã€ã®ã‚ˆã†ãªã‚·ãƒªã‚¢ã‚¹ãªæ›²ï¼‰ã§ç‰¹ã«é«˜ã„ã‚·ãƒ³ã‚¯ãƒ­ç‡ã‚’ç™ºæ®ã™ã‚‹ã‚¿ã‚¤ãƒ—ã§ã™ã€‚"
                "è‡ªåˆ†ã®å£°ã‚’æ´»ã‹ã—ãªãŒã‚‰ã€è¦æ‰€ã§ãã‚‰ã‚‹ã•ã‚“ã®ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã‚’å–ã‚Šå…¥ã‚Œã‚‹ã®ãŒä¸€ç•ªè¼ãã‚¹ã‚¿ã‚¤ãƒ«ã¨è¨€ãˆã¾ã™ã€‚")

    elif rate >= 55:
        return ("ã€å…±é³´ã®äºˆæ„Ÿã€‘å£°ã®å¯†åº¦ã‚„å¸¯åŸŸã®ãƒãƒ©ãƒ³ã‚¹ã«ã€ãã‚‰ã‚‹ã•ã‚“ã¨å…±é€šã™ã‚‹ãƒ‘ãƒ¼ãƒ„ã‚’ç¢ºèªã—ã¾ã—ãŸã€‚ç¾åœ¨ã¯ã‚ãªãŸç‹¬è‡ªã®æ­Œã„æ–¹ãŒå¼·ãå‡ºã¦ã„ã¾ã™ãŒã€"
                "å£°è³ªãã®ã‚‚ã®ã«ã¯ã€é€æ˜æ„Ÿã€ã®ç´ è³ªãŒååˆ†ã«ã‚ã‚Šã¾ã™ã€‚ã‚¦ã‚£ã‚¹ãƒ‘ãƒ¼ãƒœã‚¤ã‚¹ã®ç·´ç¿’ã‚’é‡ã­ã‚‹ã“ã¨ã§ã€"
                "ã‚ãªãŸã®å–‰ã®ä¸­ã«çœ ã£ã¦ã„ã‚‹ã€ãã‚‰ã‚‹æˆåˆ†ã€ã‚’ã‚‚ã£ã¨å¼•ãå‡ºã™ã“ã¨ãŒã§ãã‚‹ã¯ãšã€‚å¯èƒ½æ€§ã«æº€ã¡ãŸæ•°å€¤ã§ã™ã€‚")

    elif rate >= 50:
        return ("ã€å”¯ä¸€ç„¡äºŒã®éŸ¿ãã€‘è‡ªåˆ†è‡ªèº«ã®å€‹æ€§ãŒåŠåˆ†ã‚’å ã‚ã¦ã„ã‚‹ã€éå¸¸ã«é­…åŠ›çš„ãªãƒ–ãƒ¬ãƒ³ãƒ‰å…·åˆã§ã™ã€‚ãã‚‰ã‚‹ã•ã‚“ã®ã‚ˆã†ãªè½ã¡ç€ãã‚’æŒã¡ã¤ã¤ã‚‚ã€"
                "ã‚ãªãŸã«ã—ã‹å‡ºã›ãªã„ç‹¬è‡ªã®è‰²å½©ã‚’çºã£ãŸæ­Œå£°ã§ã™ã€‚ç„¡ç†ã«å¯„ã›ã‚‹ã‚ˆã‚Šã‚‚ã€ä»Šã®éŸ¿ãã«ãã‚‰ã‚‹ã•ã‚“ã®æ¥½æ›²ã®ä¸–ç•Œè¦³ã‚’ä¹—ã›ã‚‹ã“ã¨ã§ã€"
                "å…¨ãæ–°ã—ã„ã€ãã‚‰ã‚‹ã‚½ãƒ³ã‚°ã€ã‚’ç”Ÿã¿å‡ºã›ã‚‹æ‰èƒ½ã‚’ç§˜ã‚ã¦ã„ã¾ã™ã€‚ãã®å€‹æ€§ã‚’å¤§åˆ‡ã«ã—ã¦ãã ã•ã„ã€‚")

    elif rate >= 40:
        return ("ã€ç‹¬å‰µã®ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆãƒ»ãƒœã‚¤ã‚¹ã€‘ãã‚‰ã‚‹ã•ã‚“ã®æˆåˆ†ã‚’ãƒ™ãƒ¼ã‚¹ã«ã—ã¤ã¤ã‚‚ã€ã‚ãªãŸç‹¬è‡ªã®åŠ›å¼·ã„éŸ¿ããŒã¯ã£ãã‚Šã¨é¡”ã‚’å‡ºã—ã¦ã„ã¾ã™ã€‚"
                "ä»Šã®ã¾ã¾ã§ã‚‚ã€ãã‚‰ã‚‹ã•ã‚“ã®æ›²ã‚’è‡ªåˆ†æµã«æ­Œã„ã“ãªã›ã‚‹ã€ã€æ¨¡å€£ã‚’è¶…ãˆãŸè‡ªç«‹ã—ãŸãƒãƒ©ãƒ³ã‚¹ã®å£°è³ªã§ã™ã€‚"
                "ã‚·ãƒ³ã‚¯ãƒ­ç‡ã¨ã„ã†æ ã«åã¾ã‚‰ãªã„ã€æ­Œã„æ‰‹ã¨ã—ã¦ã®å¼·ã„ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’æ„Ÿã˜ã•ã›ã‚‹çµæœã¨ãªã‚Šã¾ã—ãŸã€‚")

    elif rate >= 30:
        return ("ã€ãƒ‹ãƒ¥ãƒ¼ãƒ»ã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã€‘ãã‚‰ã‚‹ã•ã‚“ã®å£°è³ªã¨ã¯ç•°ãªã‚‹ãƒ™ã‚¯ãƒˆãƒ«ã§ã€éå¸¸ã«ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç«‹ã£ãŸæ­Œå£°ã§ã™ã€‚"
                "ã‚·ãƒ³ã‚¯ãƒ­ç‡ã¯ä½ã‚ã§ã™ãŒã€ãã‚Œã¯ã‚ãªãŸã®å£°ã«ã—ã£ã‹ã‚Šã¨ã—ãŸã€èŠ¯ã€ãŒã‚ã‚Šã€èª°ã®å½±éŸ¿ã‚‚å—ã‘ã¦ã„ãªã„è¨¼æ‹ ã§ã™ã€‚"
                "ãã‚‰ã‚‹ã•ã‚“ã®æ¥½æ›²ã‚’ã‚«ãƒãƒ¼ã—ã¦ã‚‚ã€åŸæ›²ã®å½±ã«éš ã‚Œãªã„åœ§å€’çš„ãªå­˜åœ¨æ„Ÿã‚’æ”¾ã¤ã“ã¨ãŒã§ãã‚‹ã€è‡ªç«‹ã—ãŸãƒœã‚¤ã‚¹ã‚¿ã‚¤ãƒ—ã¨è¨€ãˆã¾ã™ã€‚")

    elif rate >= 20:
        return ("ã€ã‚¢ãƒ³ãƒªãƒŸãƒ†ãƒƒãƒ‰ãƒ»ã‚«ãƒ©ãƒ¼ã€‘ãã‚‰ã‚‹ã•ã‚“ã®ã€ç¢§ã€ã®ä¸–ç•Œã¨ã¯å¯¾æ¥µã«ã‚ã‚‹ã‚ˆã†ãªã€ã‚¨ãƒãƒ«ã‚®ãƒƒã‚·ãƒ¥ã¾ãŸã¯ç‹¬è‡ªã®è‰²å½©ã‚’æŒã£ãŸå£°ã§ã™ã€‚"
                "æ³¢å½¢è§£æã®çµæœã€ãã‚‰ã‚‹ã•ã‚“ã®æˆåˆ†ã¨ã¯åˆ¥ã®å¸¯åŸŸã§éå¸¸ã«é«˜ã„ã‚¨ãƒãƒ«ã‚®ãƒ¼ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸã€‚ã“ã‚Œã¯æ¨¡å€£ã§ã¯ãªãå‰µé€ ã«å‘ã„ãŸå£°ã§ã‚ã‚Šã€"
                "ã‚ãªãŸã«ã—ã‹å‡ºã›ãªã„éŸ¿ãã‚’æ­¦å™¨ã«ã€æ–°ã—ã„éŸ³æ¥½ã®é“ã‚’åˆ‡ã‚Šæ‹“ãã¹ãå–‰ã®æŒã¡ä¸»ã§ã™ã€‚")

    elif rate >= 10:
        return ("ã€ã‚¢ã‚¤ãƒ‡ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã®ç¢ºç«‹ã€‘ã‚ãªãŸã®å£°ãŒèª°ã«ã‚‚ä¼¼ã¦ã„ãªã„ã€å®Œå…¨ã‚ªãƒªã‚¸ãƒŠãƒ«ã€ã§ã‚ã‚‹ã“ã¨ã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚"
                "ãã‚‰ã‚‹ã•ã‚“ã®ãƒ•ã‚¡ãƒ³ã§ã‚ã‚ŠãªãŒã‚‰ã€è‡ªåˆ†è‡ªèº«ã®å€‹æ€§ã‚’ã“ã‚Œã»ã©ç´”ç²‹ã«ä¿ã¦ã¦ã„ã‚‹ã®ã¯ä¸€ã¤ã®æ‰èƒ½ã§ã™ã€‚"
                "ãã‚‰ã‚‹ã•ã‚“ã®æ¥½æ›²ã‚’ã‚ãªãŸãŒæ­Œã†ã“ã¨ã§ã€åŸæ›²ã¨ã¯å…¨ãé•ã†ã€ã‚ãªãŸã«ã—ã‹æ•‘ãˆãªã„ãƒªã‚¹ãƒŠãƒ¼ã«å±Šãæ–°ã—ã„å‘½ãŒå¹ãè¾¼ã¾ã‚Œã‚‹ã§ã—ã‚‡ã†ã€‚")

    else:
        return ("ã€ç©¶æ¥µã®ã‚ªãƒªã‚¸ãƒŠãƒªãƒ†ã‚£ã€‘æ¸¬å®šä¸èƒ½ï¼ãã‚‰ã‚‹ã•ã‚“ã®æˆåˆ†ã‚’ã»ã¼æ¤œçŸ¥ã§ããªã„ã»ã©ã€ã‚ãªãŸã®å€‹æ€§ã¯çªãæŠœã‘ã¦ã„ã¾ã™ã€‚"
                "ã‚ã‚‹æ„å‘³ã€ã“ã®ã‚µã‚¤ãƒˆã§æœ€ã‚‚è²´é‡ãªã€0%ã«è¿‘ã„å¸Œå°‘ãªéŸ¿ãã€ã®æŒã¡ä¸»ã§ã™ã€‚æ—¢å­˜ã®æ çµ„ã¿ã«ã¯ã¾ã‚‰ãªã„ãã®å£°ã‚’å¤§åˆ‡ã«ã€"
                "è‡ªåˆ†ã ã‘ã®é“ã‚’çªãé€²ã‚“ã§ãã ã•ã„ã€‚ãã®éŸ¿ãã¯ã€èª°ã«ã‚‚çœŸä¼¼ã§ããªã„ã‚ãªãŸã ã‘ã®å®ç‰©ã§ã™ã€‚")


# ====== URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿èª­ã¿å–ã‚Š ======
params = st.query_params

shared_rate = None
shared_song = None

if "rate" in params:
    try:
        shared_rate = float(params["rate"])
    except:
        shared_rate = None

if "song1" in params:
    shared_song = params["song1"]

# ====== å…±æœ‰ãƒ¢ãƒ¼ãƒ‰ ======
if shared_rate is not None:
    st.subheader("ğŸ” å…±æœ‰ã•ã‚ŒãŸè¨ºæ–­çµæœ")

    st.markdown(f"""
    <div class="result-box">
        <h2>ã‚ãªãŸã®ãã‚‰ã‚‹ãƒ»ã‚·ãƒ³ã‚¯ãƒ­ç‡ï¼š {shared_rate:.1f}%</h2>
        <p>{generate_comment(shared_rate)}</p>
    </div>
    """, unsafe_allow_html=True)

    if shared_song:
        st.markdown(f"### ğŸ¥‡ ç¬¬1ä½ï¼š{shared_song}")

    st.stop()


# ====== CSSï¼ˆãã‚‰ã‚‹ãƒ†ãƒ¼ãƒï¼‰ ======
st.markdown("""
<style>

body {
    background-color: #f4f8ff;
    font-family: 'Hiragino Maru Gothic ProN', 'Yu Gothic', sans-serif;
}

/* ã‚¿ã‚¤ãƒˆãƒ«ã‚«ãƒ¼ãƒ‰ */
.title-card {
    background: linear-gradient(135deg, #e9f2ff, #d7e6ff);
    padding: 35px 20px;
    border-radius: 18px;
    border: 2px solid #8fb4ff;
    margin-bottom: 25px;
    box-shadow: 0 4px 12px rgba(120, 150, 220, 0.25);
}

/* ã‚¿ã‚¤ãƒˆãƒ«æ–‡å­— */
.title-text {
    color: #0f1a33;
    font-weight: 800;
    font-size: 2.3rem;
    line-height: 1.3;
    text-align: center;
    text-shadow: 0px 1px 3px rgba(255,255,255,0.9);
}

/* ã‚µãƒ–ã‚¿ã‚¤ãƒˆãƒ« */
.subtitle-text {
    color: #2a4d8f;
    font-size: 1.1rem;
    text-align: center;
    margin-top: 8px;
}

/* ã‚³ãƒ¡ãƒ³ãƒˆãƒœãƒƒã‚¯ã‚¹ */
.result-box {
    background: #f9fbff;
    padding: 22px;
    border-left: 6px solid #5fa8ff;
    border-radius: 10px;
    margin: 20px 0;
    border: 1px solid #bcd4ff;
    box-shadow: 0 3px 10px rgba(150, 180, 255, 0.25);
}

.result-box h2, .result-box p {
    color: #0f1a33;
}

/* ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚«ãƒ¼ãƒ‰ */
.song-card {
    background: #ffffff;
    border: 2px solid #bcd4ff;
    padding: 18px;
    border-radius: 12px;
    margin-bottom: 14px;
    box-shadow: 0 3px 10px rgba(180, 200, 255, 0.25);
}

.song-card h3, .song-card h4, .song-card a {
    color: #0f1a33;
}

/* ãƒ•ã‚©ãƒ³ãƒˆçµ±ä¸€ */
h1, h2, h3, h4, p, div {
    font-family: 'Hiragino Maru Gothic ProN', 'Yu Gothic', sans-serif;
}

</style>
""", unsafe_allow_html=True)


# ====== ã‚¿ã‚¤ãƒˆãƒ« ======
st.markdown("""
<div class="title-card">
    <div class="title-text">
        ã€ç²¾å¯†è§£æã€‘<br>ãã‚‰ã‚‹ãƒ»ã‚·ãƒ³ã‚¯ãƒ­ç‡ãƒã‚§ãƒƒã‚«ãƒ¼
    </div>
    <div class="subtitle-text">
        ã‚ãªãŸã®å£°ã«æœ€ã‚‚è¿‘ã„æ¥½æ›²ã‚‚åˆ¤å®šï¼
    </div>
</div>
""", unsafe_allow_html=True)

# ====== SNSã‚¢ã‚¤ã‚³ãƒ³ ======
st.markdown("""
<div style="text-align:center;">
<a href="https://twitter.com/soraruru" target="_blank">
    <img src="https://abs.twimg.com/favicons/twitter.ico" width="32">
</a>
&nbsp;&nbsp;
<a href="https://www.youtube.com/@soraru" target="_blank">
    <img src="https://www.youtube.com/s/desktop/fe2f1f8e/img/favicon_32x32.png" width="32">
</a>
</div>
""", unsafe_allow_html=True)

st.markdown("---")

# ====== ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ ======
st.subheader("â‘  éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")
st.write("**å¯¾å¿œå½¢å¼ï¼š** wav / mp3 / m4a")
st.write("**æ¨å¥¨ï¼š** 10ã€œ20ç§’ã®ã‚µãƒ“ã‚„ç››ã‚Šä¸ŠãŒã‚Šéƒ¨åˆ†ï¼ˆå£°ãŒå¤§ãã„ã¨ã“ã‚ï¼‰")
st.write("â€» å£°ã ã‘ãƒ»ã‚¢ã‚«ãƒšãƒ©ã ã¨ã‚ˆã‚Šç²¾åº¦ãŒä¸ŠãŒã‚Šã¾ã™")
uploaded_file = st.file_uploader(
    "ã“ã“ã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã—ã¦ãã ã•ã„",
    type=["wav", "mp3"]
)

st.markdown("---")

# ====== ç²¾å¯†è§£æ ======
st.subheader("â‘¡ ç²¾å¯†è§£æ")
analyze_button = st.button("ğŸ” ç²¾å¯†è§£æã‚¹ã‚¿ãƒ¼ãƒˆ")

if analyze_button:
    if uploaded_file is None:
        st.warning("å…ˆã«éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚")
    else:
        with st.spinner("è§£æä¸­â€¦"):
            try:
                user_feat = extract_user_features_from_file(uploaded_file, duration=15)
                soraru_rate, result = analyze_all(user_feat, df)
            except Exception as e:
                st.error(f"è§£æä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸï¼š{e}")
                st.stop()
        st.success("è§£æãŒå®Œäº†ã—ã¾ã—ãŸï¼")

        # ====== çµæœ ======
        st.subheader("â‘¢ çµæœ")

        st.markdown(f"""
        <div class="result-box">
            <h2>ã‚ãªãŸã®ãã‚‰ã‚‹ãƒ»ã‚·ãƒ³ã‚¯ãƒ­ç‡ï¼š {soraru_rate:.1f}%</h2>
            <p>{generate_comment(soraru_rate)}</p>
        </div>
        """, unsafe_allow_html=True)

        st.markdown("---")

        # ====== ãƒ©ãƒ³ã‚­ãƒ³ã‚° ======
        st.subheader("â‘£ ã‚ãªãŸã«è¿‘ã„ ãã‚‰ã‚‹æ¥½æ›² TOP5")

        top5 = result.head(5).reset_index(drop=True)

        # 1ä½
        top1 = top5.iloc[0]
        st.markdown(f"""
        <div class="song-card">
            <h3>ğŸ¥‡ ç¬¬1ä½ï¼š{top1['song']}ï¼ˆ{top1['score']:.1f}%ï¼‰</h3>
        </div>
        """, unsafe_allow_html=True)
        st.video(top1["url"])
        st.write(f"[YouTubeã§é–‹ã]({top1['url']})")

        # 2ã€œ5ä½
        for i in range(1, len(top5)):
            row = top5.iloc[i]
            st.markdown(f"""
            <div class="song-card">
                <h4>ç¬¬{i+1}ä½ï¼š{row['song']}ï¼ˆ{row['score']:.1f}%ï¼‰</h4>
                <a href="{row['url']}" target="_blank">YouTubeã§é–‹ã</a>
            </div>
            """, unsafe_allow_html=True)

        st.markdown("---")

else:
    st.info("éŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‹ã‚‰ã€Œç²¾å¯†è§£æã‚¹ã‚¿ãƒ¼ãƒˆã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚")

